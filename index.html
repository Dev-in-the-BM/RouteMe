<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

    :root {
      --primary-color: #1766fa;
      --secondary-color: #3b82f6;
      --dark-color: #000000;
      --font-color: #ffffff;
      --border-color: rgba(255, 255, 255, 0.1);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--dark-color);
      color: var(--font-color);
      padding: 2rem;
      overflow-x: hidden;
    }
    
    .text-body-secondary, .text-secondary {
      color: rgba(255, 255, 255, 0.85) !important;
    }

    .form-label, .form-check-label, .modal-title {
      color: var(--font-color);
    }

    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .btn-secondary {
      color: #fff;
      background-color: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.4s ease;
    }

    .btn-secondary:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 12px 25px rgba(80, 80, 80, 0.2);
      background-color: rgba(255, 255, 255, 0.25);
    }
    
    #gradient-blob-container {
        position: fixed;
        inset: 0;
        z-index: -1;
        overflow: hidden;
    }

    .container {
      max-width: 900px;
      margin: auto;
      position: relative;
      z-index: 1;
    }

    .card {
      background: rgba(35, 35, 45, 0.75);
      backdrop-filter: blur(20px) saturate(150%);
      -webkit-backdrop-filter: blur(20px) saturate(150%);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      margin-bottom: 3rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      border-color: var(--primary-color);
      transform: translateY(-10px) scale(1.04);
      box-shadow: 0 25px 50px rgba(23, 102, 250, 0.3);
    }

    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -150%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(23, 102, 250, 0.2), transparent);
        transition: left 0.8s ease;
    }

    .card:hover::before {
        left: 150%;
    }

    .card-header {
      background: transparent;
      color: var(--font-color);
      font-weight: 700;
      border-bottom: 1px solid var(--border-color);
      padding: 1.5rem;
    }
    
    .form-control, .form-select {
      background-color: rgba(0, 0, 0, 0.3);
      color: var(--font-color);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
    }

    .form-control:focus, .form-select:focus {
      background-color: rgba(0, 0, 0, 0.5);
      color: var(--font-color);
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(23, 102, 250, 0.3);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.4s ease;
    }

    .btn-primary:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 12px 25px rgba(23, 102, 250, 0.4);
    }

    .group-item {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 18px;
      padding: 1.5rem 2rem;
      margin-bottom: 1.5rem;
      transition: all 0.4s ease;
      border: 1px solid var(--border-color);
      cursor: pointer;
    }
    
    .group-item:hover {
        background-color: rgba(255, 255, 255, 0.12);
        transform: scale(1.03);
        border-color: var(--primary-color);
    }

    .modal-content {
      background: rgba(15, 15, 15, 0.8);
      backdrop-filter: blur(25px);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      color: var(--font-color);
    }

    .loader {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--dark-color);
        display: flex; align-items: center; justify-content: center; z-index: 9999;
    }

    .group-item .btn {
        border: none;
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .group-item .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .group-item .edit-btn.btn-outline-light {
        background-color: rgba(255, 255, 255, 0.15);
        color: #fff;
    }

    .group-item .edit-btn.btn-outline-light:hover {
        background-color: rgba(255, 255, 255, 0.25);
    }

    .group-item .delete-btn.btn-outline-danger {
        background-color: rgba(220, 53, 69, 0.2);
        color: #ff9aa2;
    }

    .group-item .delete-btn.btn-outline-danger:hover {
        background-color: rgba(220, 53, 69, 0.4);
        color: #fff;
    }

  </style>
</head>
<body>
  <div id="gradient-blob-container"></div>
  <div id="loader" class="loader">
      <div class="spinner-border" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status">
          <span class="visually-hidden">Loading...</span>
      </div>
  </div>

  <div class="container">
    <div class="text-center my-5">
      <h1 class="display-3 fw-bold text-light">RouteMe Settings</h1>
    </div>

    <div id="setup-card" class="card" style="display: none;">
      <div class="card-header">
        <h2>One-Time Setup</h2>
      </div>
      <div class="card-body p-4">
        <p class="text-body-secondary">This script requires a one-time setup to create a logging spreadsheet and set a timer to check for new messages.</p>
        <button id="run-setup-btn" class="btn btn-primary">Run Automated Setup</button>
        <div id="setup-status" class="mt-3"></div>
      </div>
    </div>

    <div id="main-settings">
      <div class="card">
        <div class="card-header">
          <h2>Access Token</h2>
        </div>
        <div class="card-body p-4">
          <div class="row g-3 align-items-center">
            <div class="col">
              <label for="GROUPME_TOKEN" class="form-label">GroupMe Access Token</label>
              <input type="password" class="form-control" id="GROUPME_TOKEN">
            </div>
            <div class="col-auto">
              <button id="save-token-btn" class="btn btn-primary mt-4">Save Token</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Global Settings</h2>
        </div>
        <div class="card-body p-4">
          <div id="global-settings-form" class="row g-4">
            <div class="col-md-4">
              <label for="USER_PREFIX" class="form-label">Fallback User Prefix</label>
              <input type="text" class="form-control" id="USER_PREFIX">
            </div>
            <div class="col-md-4">
              <label for="USER_COUNT" class="form-label">Fallback User Count</label>
              <input type="number" class="form-control" id="USER_COUNT">
            </div>
            <div class="col-md-4">
              <label for="SHMUZTECH_COUNT" class="form-label">ShmuzTech Onboarding Count</label>
              <input type="number" class="form-control" id="SHMUZTECH_COUNT">
            </div>
          </div>
           <div class="d-flex justify-content-end mt-4">
              <button id="save-global-btn" class="btn btn-primary">Save Globals</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2>Group Management</h2>
          <button id="add-group-btn" class="btn btn-primary">Add New Group</button>
        </div>
        <div class="card-body p-4">
          <div id="group-list"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="group-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="modal-title">Add New Group</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <form id="group-form">
            <input type="hidden" id="original-group-id">
            <input type="hidden" id="original-keywords-str">
            <div class="mb-3">
              <label for="keywords" class="form-label">Keywords (comma-separated)</label>
              <input type="text" class="form-control" id="keywords" required>
            </div>
            <div class="mb-3">
              <label for="groupId" class="form-label">Group</label>
              <select class="form-select" id="groupId" required></select>
            </div>
            <hr class="my-4 border-secondary">
            <p class="text-secondary small">Optional: Override global settings for this group.</p>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="prefix" class="form-label">Custom Prefix</label>
                <input type="text" class="form-control" id="prefix" placeholder="Use global">
              </div>
              <div class="col-md-6">
                <label for="count" class="form-label">Custom Count</label>
                <input type="number" class="form-control" id="count" placeholder="Use global">
              </div>
            </div>
            <div class="form-check mt-4">
              <input class="form-check-input" type="checkbox" id="useBatchAdd">
              <label class="form-check-label" for="useBatchAdd">
                Use Batch Add API (recommended)
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" form="group-form" class="btn btn-primary">Save Group</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="toast"></div>

  <template id="group-template">
    <div class="group-item">
      <div>
        <h5 class="keywords mb-1 text-light"></h5>
        <small class="text-body-secondary">Group: <span class="groupName"></span></small>
        <small class="text-body-secondary ms-3">Prefix: <span class="prefix"></span></small>
        <small class="text-body-secondary ms-3">Count: <span class="count"></span></small>
        <small class="text-body-secondary ms-3">Add Method: <span class="addMethod"></span></small>
      </div>
      <div class="group-actions">
        <button class="btn btn-outline-light btn-sm edit-btn">Edit</button>
        <button class="btn btn-outline-danger btn-sm delete-btn ms-2">Delete</button>
      </div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script>
    // --- GSAP Animations and Page Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        const loader = document.getElementById('loader');
        gsap.to(loader, { opacity: 0, duration: 0.5, onComplete: () => loader.style.display = 'none' });

        gsap.from('.container', { opacity: 0, y: -30, duration: 1, ease: 'power3.out', delay: 0.3 });

        // Animated Gradient Blobs
        const blobContainer = document.getElementById('gradient-blob-container');
        const blobCount = 15;
        const colors = ['#1766fa', '#3b82f6', '#ec4899', '#f59e0b', '#34d399'];

        for (let i = 0; i < blobCount; i++) {
            const blob = document.createElement('div');
            blob.style.position = 'absolute';
            const size = gsap.utils.random(window.innerWidth * 0.2, window.innerWidth * 0.4);
            blob.style.width = `${size}px`;
            blob.style.height = `${size}px`;
            blob.style.background = `radial-gradient(circle, ${gsap.utils.random(colors)} 40%, transparent 70%)`;
            blob.style.borderRadius = '50%';
            blob.style.filter = `blur(${gsap.utils.random(120, 180)}px)`;
            blob.style.opacity = gsap.utils.random(0.3, 0.7);
            blobContainer.appendChild(blob);

            gsap.set(blob, {
                x: gsap.utils.random(0, window.innerWidth - size),
                y: gsap.utils.random(0, window.innerHeight - size),
            });

            function animateBlob() {
                gsap.to(blob, {
                    x: gsap.utils.random(0, window.innerWidth - size),
                    y: gsap.utils.random(0, window.innerHeight - size),
                    duration: gsap.utils.random(15, 30),
                    ease: 'power1.inOut',
                    onComplete: animateBlob
                });
            }
            animateBlob();
        }
    });

    let currentGroups = [];
    let groupNameMap = {}; // To store group names by ID
    const groupList = document.getElementById('group-list');
    const groupTemplate = document.getElementById('group-template');
    const groupModal = new bootstrap.Modal(document.getElementById('group-modal'));
    const modalTitle = document.getElementById('modal-title');
    const groupForm = document.getElementById('group-form');
    const toast = document.getElementById('toast');

    // --- Data Fetching and Rendering ---
    document.addEventListener('DOMContentLoaded', () => {
      google.script.run.withSuccessHandler(updateSetupUI).checkSetupStatus();

      google.script.run.withSuccessHandler(token => {
        document.getElementById('GROUPME_TOKEN').value = token;
      }).getGroupMeToken();

      google.script.run.withSuccessHandler(groups => {
        const groupSelect = document.getElementById('groupId');
        groupSelect.innerHTML = ''; // Clear existing options
        groupNameMap = {}; // Clear the map
        groups.forEach(group => {
          groupNameMap[group.id] = group.name;
          const option = document.createElement('option');
          option.value = group.id;
          option.textContent = group.name;
          groupSelect.appendChild(option);
        });

        // Now that the map is populated, render the groups that use it
        loadGroups();
      }).getGroupMeGroups();

      google.script.run.withSuccessHandler(settings => {
        document.getElementById('USER_PREFIX').value = settings.USER_PREFIX;
        document.getElementById('USER_COUNT').value = settings.USER_COUNT;
        document.getElementById('SHMUZTECH_COUNT').value = settings.SHMUZTECH_COUNT;
      }).getGlobalSettings();
    });

    function updateSetupUI(isSetupComplete) {
      const setupCard = document.getElementById('setup-card');
      const mainSettings = document.getElementById('main-settings');
      if (!isSetupComplete) {
        mainSettings.style.display = 'none';
        setupCard.style.display = 'block';
        gsap.from(setupCard, { opacity: 0, y: -20, duration: 0.5 });
      } else {
        mainSettings.style.display = 'block';
        setupCard.style.display = 'none';
      }
    }

    document.getElementById('run-setup-btn').addEventListener('click', () => {
      const statusDiv = document.getElementById('setup-status');
      statusDiv.textContent = 'Running setup...';
      google.script.run.withSuccessHandler(message => {
        statusDiv.textContent = message;
        if (message.includes('successfully')) {
          setTimeout(() => {
            updateSetupUI(true);
          }, 2000);
        }
      }).runFirstTimeSetup();
    });

    function renderGroups() {
      groupList.innerHTML = '';
      currentGroups.forEach((group, index) => {
        const clone = groupTemplate.content.cloneNode(true);
        const groupItem = clone.querySelector('.group-item');
        
        clone.querySelector('.keywords').textContent = group.keywords.join(', ');
        clone.querySelector('.groupName').textContent = groupNameMap[group.groupId] || group.groupId;
        clone.querySelector('.prefix').textContent = group.prefix || '(Global)';
        clone.querySelector('.count').textContent = group.count || '(Global)';
        clone.querySelector('.addMethod').textContent = group.useBatchAdd === false ? 'One-by-one' : 'Batch';
        
        const editBtn = clone.querySelector('.edit-btn');
        editBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent card click from firing
            handleEdit(group.groupId);
        });
        
        const deleteBtn = clone.querySelector('.delete-btn');
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            handleDelete(group.groupId);
        });
        
        groupItem.addEventListener('click', () => handleEdit(group.groupId));

        groupList.appendChild(clone);

        gsap.from(groupItem, { y: 20, duration: 0.4, delay: index * 0.03, ease: 'power3.out' });
      });
    }

    // --- Modal Handling ---
    function openModal(mode, group) {
      groupForm.reset();
      if (mode === 'edit') {
        modalTitle.textContent = 'Edit Group';
        document.getElementById('original-group-id').value = group.groupId;
        document.getElementById('original-keywords-str').value = group.keywords.join(',');
        document.getElementById('keywords').value = group.keywords.join(', ');
        document.getElementById('groupId').value = group.groupId;
        document.getElementById('prefix').value = group.prefix || '';
        document.getElementById('count').value = group.count || '';
        document.getElementById('useBatchAdd').checked = group.useBatchAdd !== false;
      } else {
        modalTitle.textContent = 'Add New Group';
        document.getElementById('original-group-id').value = '';
        document.getElementById('original-keywords-str').value = '';
        document.getElementById('useBatchAdd').checked = true;
      }
      groupModal.show();
    }

    function closeModal() {
      groupModal.hide();
    }

    // --- Event Handlers ---
    document.getElementById('add-group-btn').addEventListener('click', () => openModal('add'));

    document.getElementById('save-token-btn').addEventListener('click', () => {
      const token = document.getElementById('GROUPME_TOKEN').value;
      google.script.run.withSuccessHandler(() => {
        showToast('Token saved successfully!');
        // Re-fetch groups and configs since the token might have changed
        google.script.run.withSuccessHandler(groups => {
          const groupSelect = document.getElementById('groupId');
          groupSelect.innerHTML = ''; // Clear existing options
          groupNameMap = {}; // Clear the map
          groups.forEach(group => {
            groupNameMap[group.id] = group.name;
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            groupSelect.appendChild(option);
          });
          loadGroups(); // Reload the group configs
        }).getGroupMeGroups();
      }).saveGroupMeToken(token);
    });
    
    document.getElementById('save-global-btn').addEventListener('click', () => {
      const settings = {
        USER_PREFIX: document.getElementById('USER_PREFIX').value,
        USER_COUNT: document.getElementById('USER_COUNT').value,
        SHMUZTECH_COUNT: document.getElementById('SHMUZTECH_COUNT').value,
      };
      google.script.run.withSuccessHandler(() => showToast('Global settings saved!')).saveGlobalSettings(settings);
    });

    function loadGroups() {
      google.script.run.withSuccessHandler(configs => {
        currentGroups = configs;
        renderGroups();
      }).getGroupConfigs();
    }

    function handleEdit(groupId) {
      const group = currentGroups.find(g => g.groupId === groupId);
      openModal('edit', group);
    }
    
    function handleDelete(groupId) {
      const group = currentGroups.find(g => g.groupId === groupId);
      if (confirm(`Are you sure you want to delete the group for keywords "${group.keywords.join(', ')}"?`)) {
        google.script.run.withSuccessHandler(message => {
          showToast(message);
          loadGroups();
        }).deleteGroup(groupId);
      }
    }
    
    groupForm.addEventListener('submit', e => {
      e.preventDefault();
      const groupData = {
        keywords: document.getElementById('keywords').value,
        groupId: document.getElementById('groupId').value,
        prefix: document.getElementById('prefix').value,
        count: document.getElementById('count').value,
        useBatchAdd: document.getElementById('useBatchAdd').checked,
        originalGroupId: document.getElementById('original-group-id').value,
        originalKeywordsStr: document.getElementById('original-keywords-str').value,
      };
      
      google.script.run.withSuccessHandler(message => {
        showToast(message);
        loadGroups();
        closeModal();
      }).saveGroup(groupData);
    });
    
    // --- UI Feedback ---
    function showToast(message, isError = false) {
      // This function can be improved with GSAP as well
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast'; // reset classes
      toast.classList.add(isError ? 'bg-danger' : 'bg-success', 'show');
      setTimeout(() => toast.classList.remove('show'), 4000);
    }

  </script>
</body>
</html>
